"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2481],{2481:(S,u,o)=>{o.r(u),o.d(u,{RiosPageModule:()=>D});var p=o(177),g=o(4341),l=o(4742),h=o(8986),d=o(467),i=o(3953),R=o(369),U=o(9644),y=o(9649),f=o(1626);let P=(()=>{var e;class r{constructor(t){this.http=t,this.apiUrl="http://localhost/riversf/public/APIU/getUserpos",this.apiUrl2="http://localhost/riversf/public/APIU/getUserest",this.apiUrl3="http://localhost/riversf/public/APIU/idalert"}getPos(t){return this.http.post(this.apiUrl,{user_id:t})}getUserest(t){return this.http.post(this.apiUrl2,{est_id:t})}envialert(t){return this.http.post(this.apiUrl3,{userpos_id:t})}}return(e=r).\u0275fac=function(t){return new(t||e)(i.KVO(f.Qq))},e.\u0275prov=i.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}),r})();const M=[{path:"",component:(()=>{var e;class r{constructor(t,s,n,c){this.storage=t,this.riogetService=s,this.geolocation=n,this.alert=c,this.userId="",this.cuentaid="",this.estadoId="",this.usuario="",this.nombre="",this.apellido="",this.rioid="",this.email="",this.monitoreo_id="",this.disDt=[],this.userLocation={lat:0,lng:0},this.rivers=[],this.sensores=[],this.usuarios=[],this.userspos=[]}ngOnInit(){var t=this;return(0,d.A)(function*(){yield t.storage.create(),t.userId=yield t.storage.get("user_id"),t.usuario=yield t.storage.get("username"),t.cuentaid=yield t.storage.get("cuenta_id"),t.rioid=yield t.storage.get("user_rioid"),t.nombre=yield t.storage.get("user_nombre"),t.email=yield t.storage.get("user_email"),t.estadoId=yield t.storage.get("est_id"),t.apellido=yield t.storage.get("user_apellido"),t.getUserLocation()})()}obtenerRio(){var t=this;return(0,d.A)(function*(){t.riogetService.getRio(t.rioid).subscribe(s=>{"sucess"==s.status?(t.storage.set("monitoreo_id",s.data.monitoreo_id),t.monitoreo_id=s.data.monitoreo_id):console.log("Error",s.message)},s=>{console.error("Error en la peticion",s)})})()}obtenerDispositivos(t){this.riogetService.getListaDispositivos(t).subscribe(s=>{"success"==s.status?s.data.foreach(c=>{this.disDt.push({sensor_id:c.circuito_id,circuito_nombre:c.circuito_nombre})}):console.log("Obtencion de datos fallida",s.message)},s=>{console.log("Erro en la peticion",s)})}getUserLocation(){var t=this;return(0,d.A)(function*(){try{const s=yield t.geolocation.getCurrentPosition();t.userLocation.lat=s.coords.latitude,t.userLocation.lng=s.coords.longitude,console.log("Latitud:",t.userLocation.lat),console.log("Longitud:",t.userLocation.lng)}catch(s){console.error("Error obteniendo la ubicaci\xf3n:",s)}})()}
//!!!!AÃ±adir funcion para obtener rios
getRivers(){return this.riogetService.getListaRios().subscribe(t=>{"success"==t.status?this.rivers=t.data:console.log("obtencion de datos fallida",t.message)}),this.rivers}deg2rad(t){return t*(Math.PI/180)}calculateDistance(t,s,n,c){const v=this.deg2rad(n-t),m=this.deg2rad(c-s),b=Math.sin(v/2)*Math.sin(v/2)+Math.cos(this.deg2rad(t))*Math.cos(this.deg2rad(n))*Math.sin(m/2)*Math.sin(m/2);return 2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b))*6371}isNearUser(t){return this.calculateDistance(t.lat,t.lng,this.userLocation.lat,this.userLocation.lng)<=50}filterRivers(){this.userLocation?this.rivers.forEach(t=>{this.riogetService.getUbi(t.riverubi_id).subscribe(s=>{"success"==s.status?this.isNearUser({lat:s.data.ubi_latitud,lng:s.data.ubi_longitud})&&this.obtenerDispositivos(t.data.monitoreo_id):console.log("Obtencion de datos fallida",s.message)})}):console.warn("User location is not defined yet.")}obtenerSesores(){this.disDt.forEach(t=>{this.riogetService.getSensor(t.sensor_id).subscribe(s=>{"success"==s.status?this.sensores=s.data:console.log("Operacion Fallida")})})}alerta(){("1"==this.cuentaid||"3"==this.cuentaid)&&this.alert.getUserest(this.estadoId).subscribe(t=>{"success"==t.status?this.usuarios=t.data:console.log("operacion fallida",t.message)})}getPos(){this.usuarios.forEach(t=>{this.alert.getPos(t.user_id).subscribe(s=>{"success"==s.status?this.userspos.push({user_id:s.data.user_id,lattitud:s.data.latitud,longitud:s.data.longitud,userpos_id:s.data.userpos_id}):console.log("error",s.message)})})}filtrarUsers(){this.userspos.forEach(t=>{this.isNearUser({lat:t.latitud,lng:t.longitud})&&this.alert.envialert(t.userpos_id)})}}return(e=r).\u0275fac=function(t){return new(t||e)(i.rXU(R.w),i.rXU(U.G),i.rXU(y.L),i.rXU(P))},e.\u0275cmp=i.VBU({type:e,selectors:[["app-rios"]],decls:9,vars:2,consts:[[3,"translucent"],[3,"fullscreen"],["collapse","condense"],["size","large"]],template:function(t,s){1&t&&(i.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),i.EFF(3,"rios"),i.k0s()()(),i.j41(4,"ion-content",1)(5,"ion-header",2)(6,"ion-toolbar")(7,"ion-title",3),i.EFF(8,"rios"),i.k0s()()()()),2&t&&(i.Y8G("translucent",!0),i.R7$(4),i.Y8G("fullscreen",!0))},dependencies:[l.W9,l.eU,l.BC,l.ai]}),r})()}];let L=(()=>{var e;class r{}return(e=r).\u0275fac=function(t){return new(t||e)},e.\u0275mod=i.$C({type:e}),e.\u0275inj=i.G2t({imports:[h.iI.forChild(M),h.iI]}),r})();var I=o(4856);let D=(()=>{var e;class r{}return(e=r).\u0275fac=function(t){return new(t||e)},e.\u0275mod=i.$C({type:e}),e.\u0275inj=i.G2t({imports:[p.MD,g.YN,l.bv,L,I.eN,f.q1,g.X1]}),r})()}}]);